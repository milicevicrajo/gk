{% extends "base.html" %}

{% block title %}Projekat {{ project.name }}{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0 text-gray-800">{{ project.name }}</h1>
        <p class="text-body-secondary mb-0">Lokacija: {{ project.location|default:"Nije definisana" }}</p>
    </div>
        {% if can_manage %}
            <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary" href="{% url 'core:project-update' project.pk %}">Izmeni</a>
                <a class="btn btn-outline-primary" href="{% url 'core:boqcategory-create' project.pk %}">Nova kategorija</a>
                <a class="btn btn-primary" href="{% url 'core:boqitem-create' %}?project={{ project.pk }}">Nova BoQ stavka</a>

                {# NOVO: otvara modal za import #}
                <button type="button" class="btn btn-success" data-toggle="modal" data-target="#boqImportModal">
                    Importuj BoQ
                </button>
            </div>
        {% endif %}
</div>

    <div class="row mb-4">
        <div class="col-lg-4">
            <div class="card shadow mb-4 h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Informacije</h6>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Status</dt>
                        <dd class="col-sm-7">{% if project.is_active %}<span class="badge badge-success">Aktivan</span>{% else %}<span class="badge badge-secondary">Arhiviran</span>{% endif %}</dd>
                        <dt class="col-sm-5">Ukupno stavki</dt>
                        <dd class="col-sm-7">{{ total_items }}</dd>
                        <dt class="col-sm-5">Kategorije</dt>
                        <dd class="col-sm-7">{{ categories|length }}</dd>
                        <dt class="col-sm-5">Opis</dt>
                        <dd class="col-sm-7">{{ project.description|default:"Nema opisa" }}</dd>
                        <dt class="col-sm-5">Kreirano</dt>
                        <dd class="col-sm-7">{{ project.created_at|date:"d.m.Y" }}</dd>
                        <dt class="col-sm-5">Valuta</dt>
                        <dd class="col-sm-7">{{ project.boq_currency}}</dd>
                    </dl>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card shadow mb-4 h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Napomene</h6>
                </div>
                <div class="card-body">
                    <p class="mb-0 text-body-secondary">Dodelite kategorije BoQ stavkama kako bi tabovi ispod prikazali jasnu strukturu po vrstama radova. Stavke bez kategorije nalaze se u posebnom tabu.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-12"> 
        <div class="col-lg-12">
            <div class="card shadow mb-12">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Stavke iz predmera po kategorijama</h6>
                </div>
                    <div class="card-body">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" data-toggle="tab" href="#tab-overview" role="tab" aria-selected="true">Sve stavke</a>
                        </li>
                        {% for category in categories %}
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" data-toggle="tab" href="#tab-category-{{ category.pk }}" role="tab">{{ category.name }}</a>
                            </li>
                        {% endfor %}
                        {% if uncategorised_items %}
                            <li class="nav-item" role="presentation">
                                <a class="nav-link" data-toggle="tab" href="#tab-uncategorised" role="tab">Nekategorizovano</a>
                            </li>
                        {% endif %}
                    </ul>
                    <div class="tab-content pt-3">
                    <div class="tab-pane fade show active" id="tab-overview" role="tabpanel">
                        {% include "core/partials/_boq_table.html" with items=all_items show_category=True show_actions=True table_id="boq-table-overview" %}
                    </div>

                    {% for category in categories %}
                        <div class="tab-pane fade" id="tab-category-{{ category.pk }}" role="tabpanel">
                        {% include "core/partials/_boq_table.html" with items=category.items.all show_category=False show_actions=True table_id="boq-table-category-"|add:category.pk %}
                        </div>
                    {% endfor %}

                    {% if uncategorised_items %}
                        <div class="tab-pane fade" id="tab-uncategorised" role="tabpanel">
                        {% include "core/partials/_boq_table.html" with items=uncategorised_items show_category=False show_actions=True empty_message="Nema nekategorizovanih stavki." table_id="boq-table-uncategorised" %}
                        </div>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

{# === MODAL: IMPORT BOQ IZ EXCEL-A === #}
<div class="modal fade" id="boqImportModal" tabindex="-1" role="dialog" aria-labelledby="boqImportLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <form method="post" action="{% url 'core:boq_import' project.pk %}" enctype="multipart/form-data" class="modal-content">
      {% csrf_token %}
      <div class="modal-header">
        <h5 class="modal-title" id="boqImportLabel">Import BoQ za {{ project.name }}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Zatvori">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        {# Ako u contextu prosledis Django formu (BoQExcelUploadForm), koristi je ovde.
           U suprotnom, plain inputi ispod rade odmah. #}

        {# Plain file input (radi bez forme u contextu) #}
        <div class="form-group">
          <label for="id_excel">Excel fajl (.xls, .xlsx)</label>
          <input type="file" name="excel" accept=".xls,.xlsx" required class="form-control-file" id="id_excel">
          <small class="form-text text-muted">Odaberi obracun (BoQ) Excel koji ce biti uvezen.</small>
        </div>

        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="id_clear_existing" name="clear_existing">
          <label class="custom-control-label" for="id_clear_existing">
            Obrisi postojece stavke i kategorije pre importa
          </label>
        </div>

        <hr class="my-3">
        <p class="text-muted mb-0">
          Import kreira/azurira stavke po sifri (code = position_id) i otvara/azurira kategorije po redosledu sheet-ova.
        </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Otkazi</button>
        <button type="submit" class="btn btn-success">Pokreni import</button>
      </div>
    </form>
  </div>
</div>


{% endblock %}