{% extends "base.html" %}
{% load widget_tweaks %}
{% block title %}BoQ stavke{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(function () {
    $('.select2').select2({
      placeholder: "Svi projekti",
      allowClear: true,
      width: 'resolve'
    });
  });
</script>
{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">BoQ stavke</h1>
    {% if can_manage %}
        <a class="btn btn-primary" href="{% url 'core:boqitem-create' %}"><i class="fas fa-plus mr-1"></i> Nova stavka</a>
    {% endif %}
</div>
<form method="get" class="row g-2 align-items-end mb-4">
    <div class="col-auto">
        {{ filter.form.project.label_tag }}
        {% render_field filter.form.project class+="form-select select2" %}
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-outline-primary">
            <i class="fas fa-filter mr-1"></i> Filtriraj
        </button>
    </div>
    {% if request.GET.project %}
        <div class="col-auto">
            <a class="btn btn-outline-secondary" href="{% url 'core:boqitem-list' %}">
                <i class="fas fa-undo mr-1"></i> Reset
            </a>
        </div>
    {% endif %}
</form>
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Tabela sa prikazom va≈°ih stavki iz predmera</h6>
    </div>
    <div class="card-body">                
        <div class="table-responsive">
            <table id="boq-items-table" class="table table-striped table-bordered align-middle w-100">
                <thead class="thead-light">
                    <tr>
                        <th scope="col">Projekat</th>
                        <th scope="col">Sifra</th>
                        <th scope="col">Naziv</th>
                        <th scope="col">JM</th>
                        <th scope="col" class="text-end">Ugovorena kolicina</th>
                        <th scope="col" class="text-end">Jedinicna cena</th>
                        <th scope="col" class="text-end">GK listovi</th>
                        <th scope="col" class="text-end">Akcije</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in boq_items %}
                        <tr>
                            <td>{{ item.project.name }}</td>
                            <td>
                                <a href="{% url 'core:boqitem-detail' item.pk %}" class="text-decoration-none text-reset">
                                    {{ item.code }}
                                </a>
                            </td>
                            <td title="{{ item.title }}">
                                <a href="{% url 'core:boqitem-detail' item.pk %}" class="text-decoration-none text-reset">
                                    {{ item.title|default:''|truncatechars:120 }}
                                </a>
                            </td>
                            <td>{{ item.uom }}</td>
                            <td class="text-end">{{ item.contract_qty }}</td>
                            <td class="text-end">{{ item.unit_price }}</td>
                            <td class="text-end">{{ item.sheet_count|default_if_none:0 }}</td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group" aria-label="Akcije">
                                    <a class="btn btn-outline-primary" href="{% url 'core:boqitem-detail' item.pk %}"><i class="fas fa-eye"></i><span class="d-none d-lg-inline ml-1"> Detalji</span></a>
                                    {% if can_manage %}
                                        <a class="btn btn-outline-secondary" href="{% url 'core:boqitem-update' item.pk %}"><i class="fas fa-edit"></i><span class="d-none d-lg-inline ml-1"> Izmeni</span></a>
                                        <a class="btn btn-outline-danger" href="{% url 'core:boqitem-delete' item.pk %}"><i class="fas fa-trash-alt"></i><span class="d-none d-lg-inline ml-1"> Obrisi</span></a>
                                        <a class="btn btn-primary" href="{% url 'core:sheet-create' %}?boq={{ item.pk }}"><i class="fas fa-file-medical"></i><span class="d-none d-xl-inline ml-1"> Novi GK list</span></a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-body-secondary">Nema unetih stavki.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>    
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var tableElement = document.getElementById('boq-items-table');
        if (!tableElement || typeof $ === 'undefined' || !$.fn.dataTable) {
            return;
        }
        $('#boq-items-table').DataTable({
            order: [[0, 'asc'], [1, 'asc']],
            columnDefs: [
                { targets: -1, orderable: false, searchable: false },
                { targets: [4, 5, 6, 7], className: 'text-end' }
            ],
            pageLength: 25,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, 'Sve']]
        });
    });
</script>
{% endblock %}
