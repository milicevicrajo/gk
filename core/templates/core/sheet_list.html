{% extends "base.html" %}
{% load static %}

{% block title %}GK listovi{% endblock %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css">
    {{ filter.form.media.css }}
    <style>
        .select2-container--bootstrap-5 .select2-selection {
            min-height: 38px;
        }
        .select2-container--bootstrap-5 .select2-selection__rendered {
            line-height: 1.5;
        }
        .select2-container--bootstrap-5 .select2-selection__arrow {
            height: 36px;
        }
    </style>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    {{ filter.form.media.js }}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">GK listovi</h1>
    {% if can_manage %}
        <a class="btn btn-primary" href="{% url 'core:sheet-create' %}"><i class="fas fa-plus mr-1"></i> Novi GK list</a>
    {% endif %}
</div>

<form method="get" class="row g-2 align-items-end mb-4">
    <div class="col-md-3">
        <label class="form-label" for="{{ filter.form.project.id_for_label }}">{{ filter.form.project.label }}</label>
        {{ filter.form.project }}
    </div>
    <div class="col-md-4">
        <label class="form-label" for="{{ filter.form.boq.id_for_label }}">{{ filter.form.boq.label }}</label>
        {{ filter.form.boq }}
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-outline-primary"><i class="fas fa-filter mr-1"></i> Filtriraj</button>
    </div>
    {% if request.GET.project or request.GET.boq %}
        <div class="col-auto">
            <a class="btn btn-outline-secondary" href="{% url 'core:sheet-list' %}"><i class="fas fa-undo mr-1"></i> Reset</a>
        </div>
    {% endif %}
</form>
<div class="card shadow mb-4">
    <div class="card-header py-3">
        <h6 class="m-0 font-weight-bold text-primary">Tabela sa prikazom vaših listova Građevinske knjige</h6>
    </div>
    <div class="card-body">  
      <div class="table-responsive">
          <table id="gk-sheets-table" class="table table-striped table-bordered align-middle w-100">
              <thead class="thead-light">
                  <tr>
                      <th scope="col">Projekat</th>
                      <th scope="col">BoQ stavka</th>
                      <th scope="col">Sifra</th>
                      <th scope="col" class="text-end">Seq</th>
                      <th scope="col">Status</th>
                      <th scope="col">Period</th>
                      <th scope="col" class="text-end">Qty (period)</th>
                      <th scope="col" class="text-end">Qty kumulativ</th>
                      <th scope="col" class="text-end">Akcije</th>
                  </tr>
              </thead>
              <tbody>
                  {% for s in sheets %}
                      <tr>
                          <td title="{{ s.project.name }}">
                              <a href="{% url 'core:project-detail' s.project.pk %}" class="text-decoration-none text-reset">
                                  {{ s.project.name|default:''|truncatechars:65}}
                              </a>
                          </td>
                          <td title="{{ s.boq_item.title }}">
                              <a href="{% url 'core:boqitem-detail' s.boq_item.pk %}" class="text-decoration-none text-reset">
                                  {{ s.boq_item.title|default:''|truncatechars:150 }}
                              </a>
                          </td>
                          <td>{{ s.boq_item.code }}</td>
                          <td class="text-end">{{ s.seq_no }}</td>
                          <td class="text-nowrap">{{ s.get_status_display }}</td>
                          <td>
                              {% if s.period_from or s.period_to %}
                                  {% if s.period_from %}{{ s.period_from|date:"d.m.Y" }}{% endif %}
                                  {% if s.period_from and s.period_to %} - {% endif %}
                                  {% if s.period_to %}{{ s.period_to|date:"d.m.Y" }}{% endif %}
                              {% else %}
                                  N/A
                              {% endif %}
                          </td>
                          <td class="text-end">{{ s.qty_this_period|default_if_none:0|floatformat:3 }}</td>
                          <td class="text-end">{{ s.qty_cumulative|default_if_none:0|floatformat:3 }}</td>
                          <td class="text-end">
                              <div class="btn-group btn-group-sm" role="group" aria-label="Akcije">
                                  <a class="btn btn-outline-primary" href="{% url 'core:sheet-detail' s.pk %}"><i class="fas fa-eye"></i><span class="d-none d-lg-inline ml-1"> Detalj</span></a>
                                  {% if can_manage %}
                                      <a class="btn btn-outline-secondary" href="{% url 'core:sheet-update' s.pk %}"><i class="fas fa-edit"></i><span class="d-none d-lg-inline ml-1"> Izmeni</span></a>
                                      <a class="btn btn-outline-danger" href="{% url 'core:sheet-delete' s.pk %}"><i class="fas fa-trash-alt"></i><span class="d-none d-lg-inline ml-1"> Obrisi</span></a>
                                  {% endif %}
                              </div>
                          </td>
                      </tr>
                  {% empty %}
                      <tr>
                          <td colspan="9" class="text-center text-body-secondary">Nema podataka za zadati filter.</td>
                      </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
    </div>    
</div>  

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var selector = '#gk-sheets-table';
        if (typeof $ === 'undefined' || !$.fn.dataTable || !document.querySelector(selector)) {
            return;
        }
        if ($.fn.DataTable.isDataTable(selector)) {
            return;
        }
        $(selector).DataTable({
            order: [[0, 'asc'], [2, 'asc'], [3, 'asc']],
            columnDefs: [
                { targets: -1, orderable: false, searchable: false },
                { targets: [3, 6, 7], className: 'text-end' },
                { targets: 4, className: 'text-nowrap' }
            ],
            pageLength: 25,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, 'Sve']]
        });
    });
</script>
{% endblock %}
